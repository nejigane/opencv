package utils

import (
	. "github.com/smartystreets/goconvey/convey"
	"io/ioutil"
	"pfi/sensorbee/sensorbee/core"
	"pfi/sensorbee/sensorbee/data"
	"reflect"
	"testing"
)

func TestConvertObjectCandidateToMap(t *testing.T) {

	Convey("Given a object_candidate byte", t, func() {
		ctx := &core.Context{}
		obByte, err := ioutil.ReadFile("_test_obcan0")
		So(err, ShouldBeNil)

		Convey("When call convert UDF", func() {

			objMapArray, err := convertObjectCandidateToMap(ctx, obByte)

			Convey("Then process should get map", func() {
				So(err, ShouldBeNil)
				So(len(objMapArray), ShouldEqual, 1)
				objMapValue := objMapArray[0]
				So(objMapValue, ShouldNotBeNil)
				objMap, err := data.AsMap(objMapValue)
				So(err, ShouldBeNil)

				exObcan, err := data.NewMap(expectedObjectCandidate)
				So(err, ShouldBeNil)

				// should be check deep equal but not look up all element in go
				SkipSo(reflect.DeepEqual(objMap, exObcan), ShouldBeTrue)
				So(len(objMap), ShouldEqual, len(exObcan))
				So(len(objMap.String()), ShouldEqual, len(exObcan.String()))
			})
		})

	})
}

var expectedObjectCandidate = map[string]interface{}{
	"bbox": map[string]interface{}{
		"x1": 240,
		"x2": 337,
		"y1": 320,
		"y2": 516,
	},
	"camera_id":  -1,
	"confidence": 0.5901911854743958,
	"feature": []float32{
		46, 168, 84, 59, 175, 99, 199, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 175,
		134, 56, 14, 10, 163, 57, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 182, 5, 0, 59, 122, 114, 139, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 90,
		17, 80, 58, 46, 251, 67, 61, 254, 208, 140, 60, 30, 205, 152, 58, 0, 0, 0, 0,
		0, 0, 0, 0, 246, 20, 164, 54, 165, 64, 234, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 27, 245, 201, 59, 17, 250, 132, 59, 74, 153, 20,
		59, 0, 0, 0, 0, 0, 0, 0, 0, 61, 37, 202, 57, 39, 30, 34, 61, 110, 57, 197, 60,
		42, 235, 42, 58, 0, 0, 0, 0, 0, 0, 0, 0, 163, 175, 252, 54, 25, 5, 53, 59, 207,
		162, 175, 56, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 246, 104, 171, 58,
		209, 184, 60, 59, 128, 145, 41, 58, 0, 0, 0, 0, 0, 0, 0, 0, 222, 239, 32, 56,
		67, 103, 139, 60, 193, 25, 168, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 74, 5,
		175, 53, 19, 207, 99, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 42, 236, 207, 57, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 69, 157, 228, 59, 186, 252, 147, 59, 202, 90, 87, 60, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 246, 200, 115, 57, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 158, 246, 16, 59, 58, 107, 8, 60, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 30, 63, 149, 58, 208, 129, 5, 61, 214, 17, 23, 61, 180,
		233, 130, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 53, 46, 206, 57, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 94, 19, 147, 59,
		246, 159, 254, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 195, 67, 78, 60, 124,
		54, 57, 61, 93, 111, 18, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3,
		122, 150, 57, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 49, 194,
		131, 59, 54, 71, 17, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 74, 142, 209, 59,
		230, 253, 8, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 170, 114,
		84, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 214, 98, 14, 59, 88,
		215, 236, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 142, 93, 157,
		59, 79, 179, 140, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 66, 15, 240, 56, 170,
		32, 170, 61, 218, 30, 131, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 66,
		203, 95, 59, 188, 24, 56, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 214, 92, 27,
		58, 70, 152, 99, 61, 19, 150, 137, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 82,
		39, 43, 56, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 243, 154, 237, 58, 84, 239, 47, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		94, 4, 90, 57, 108, 86, 38, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 110, 58, 217, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		51, 91, 228, 57, 220, 225, 141, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 114, 213, 231, 56, 26, 185, 79, 54, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 21, 226, 9, 59, 165, 72, 128, 61, 248, 109, 96, 59, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 170, 25, 11, 56, 171, 212, 245, 59, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 40, 234, 64, 59, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 75, 132, 156, 58, 217, 193, 133, 61, 122, 237, 174, 60,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 138, 137, 17, 60, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32, 20, 44, 60, 24, 61, 41, 59, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 68, 141, 128, 58, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 139, 207, 237, 59, 213, 9, 107, 59, 70,
		237, 195, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 146, 203, 104,
		57, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 171, 66, 141,
		58, 0, 248, 51, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 82, 181, 57, 80,
		235, 21, 61, 206, 71, 1, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		50, 74, 197, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 234,
		16, 94, 60, 211, 25, 235, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 203, 133,
		139, 57, 247, 111, 46, 61, 6, 127, 151, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 195, 1, 125, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 79, 137, 41, 59, 171, 242, 82, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 118, 101, 255, 60, 135, 39, 201, 59, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 11, 157, 104, 54, 75, 99, 252, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 30, 223, 57, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 14, 161, 101, 60,
	},
	"height": 1.8033740520477295,
	"position": map[string]interface{}{
		"x": 8.064379692077637,
		"y": 10.850149154663086,
		"z": 0,
	},
	"tags": []interface{}{
		map[string]interface{}{
			"key":   "gender",
			"score": 0.955210268497467,
			"value": "Male",
		},
	},
}
